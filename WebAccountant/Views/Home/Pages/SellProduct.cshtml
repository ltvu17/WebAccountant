@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model WebAccountant.Models.FormBanHangDTO
@{
    Html.RenderPartial("../Home/Header");
}

<div>
    <div class="home-container">
        @Html.Partial("../Home/SideBar")
        <div class="right-bar-home content mua-page">
            <nav class="navbar navbar-expand-lg navbar-light bg-light d-flex t-s-14">
                <div class="container-fluid">
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item">
                                <a class="nav-link active" id="data-link" aria-current="page" href="#" onclick="listOut()">Danh sách</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="order-link" onclick="orderOut()">Bán hàng</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <div id="mua-data" >
                @(Html.DevExtreme().DataGrid<WebAccountant.Models.PhieuBanHangDTO>()
                    .DataSource(ds => ds.Mvc()
                    .Controller("Ktscs")
                    .LoadAction("GetALLDSPhieuBanHang")
                    .ErrorHandler("error")
                    .Key("id")
                    )
                    .RemoteOperations(true).FocusedRowEnabled(true)
                    .Columns(columns =>
                    {
                        columns.AddFor(s => s.NgayCtu).Caption("Ngày chứng từ");
                        columns.AddFor(s => s.Soctu).Caption("Số chứng từ");
                        columns.AddFor(s => s.HTThanhToan).Caption("Hình thức thanh toán");
                        columns.AddFor(s => s.ThanhTien).Caption("Thành tiền");
                        columns.AddFor(s => s.ckPhanTram);
                        columns.AddFor(s => s.CkThanhTien).Caption("Chiết khấu thành tiền");
                        columns.AddFor(s => s.TongTien).Caption("Tổng tiền");
                        columns.AddFor(s => s.KhTraTien);
                        columns.AddFor(s => s.MaKh).Caption("Mã khách hàng");
                        columns.AddFor(s => s.TenKh).Caption("Tên khách hàng");
                        columns.AddFor(s => s.MsThue).Caption("Mã số thuế");
                        columns.AddFor(s => s.Diachi).Caption("Địa chỉ");
                        columns.AddFor(s => s.GhiChu).Caption("Ghi chú");
                        columns.AddFor(s => s.NhanVienBan).Caption("Nhân viên bán");
                    })
                    .ColumnAutoWidth(true).AllowColumnResizing(true).ColumnResizingMode(ColumnResizingMode.Widget).FilterRow(ft => ft.Visible(true))
                    .ShowBorders(true)
                    .RowAlternationEnabled(true)
                    .Paging(paging => paging.PageSize(10))
                    .Pager(pager =>
                    {
                        pager.Visible(true);
                        pager.DisplayMode(GridPagerDisplayMode.Compact);
                        pager.ShowPageSizeSelector(true);
                        pager.AllowedPageSizes(new JS("[10, 20, 30]"));
                        pager.ShowInfo(true);
                        pager.ShowNavigationButtons(true);
                    })
                    .OnContextMenuPreparing("edit").ID("grid")
                    )
            </div>
            <div id="edit-page" class="d-none"></div>
            <form id="myForm" class="d-none" asp-controller="Ktdms" asp-action="SubmitCartToSave">
                <div class="top-content">
                    @*Content*@
                    <div class="row">
                        @*Forms*@
                        <div class="mua-form col-8">
                            @* Navbar *@
                            <ul class="nav nav-tabs mua-form-nav">
                                <li class="nav-item">
                                    <button class="nav-link active" id="btn-phieunhap" type="button" onclick="phieuOut()">Phiếu bán</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" id="btn-hoadon" type="button" onclick="hoadonOut()">Hóa đơn</button>
                                </li>
                            </ul>
                            @*Phieu nhap*@
                            <div id="phieu-nhap" class="row">
                                <div id="infor-phieu-nhap" class="col-9">
                                    <div class="row">
                                        <div class="col-4 col-num-1">
                                            <div class="mb-3 text-start">
                                                <label for="input-makh" class="col-form-label">Mã khách hàng:</label>
                                                <div class="d-flex justify-content-between">
                                                    <input type="text"
                                                           class="form-control input-sugg width-pt-80"
                                                           id="input-makh"
                                                           autofocus="autofocus"
                                                           autocomplete="off"
                                                           asp-for="Makh"
                                                           onkeyup="SearchNow('list-makh-sugg','input-makh','list-makh-sugg')" />
                                                    <div class="height-30 width-pt-15" data-bs-toggle="modal" data-bs-target="#exampleModal">
                                                        <svg class="add-kh" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="green" d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM200 344V280H136c-13.3 0-24-10.7-24-24s10.7-24 24-24h64V168c0-13.3 10.7-24 24-24s24 10.7 24 24v64h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H248v64c0 13.3-10.7 24-24 24s-24-10.7-24-24z" /></svg>
                                                    </div>
                                                    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                                        <div class="modal-dialog modal-xl">
                                                            <div class="modal-content add-kh-form">
                                                                    <div class="add-kh-form-header d-flex justify-content-between">
                                                                        <h6 class="modal-title main-color" id="exampleModalLabel">Thêm khách hàng</h6>
                                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                    </div>
                                                                <div class="add-kh-form-body">
                                                                    <div class="main-body row">
                                                                        <div class="col-3">
                                                                            <div class="mb-3 text-start">
                                                                                <label for="makh-add" class="col-form-label">Mã khách hàng:</label>
                                                                                <input type="text"
                                                                                       id="makh-add"
                                                                                       class="form-control"
                                                                                       autofocus="autofocus"
                                                                                       autocomplete="off" />
                                                                            </div>
                                                                            <div class="mb-3 text-start">
                                                                                <label for="msdn-add" class="col-form-label">Mã số doanh nghiệp:</label>
                                                                                <input type="text"
                                                                                       id="msdn-add"
                                                                                       class="form-control"
                                                                                       autofocus="autofocus"
                                                                                       autocomplete="off" />
                                                                            </div>

                                                                        </div>
                                                                        <div class="col-7">
                                                                            <div class="mb-3 text-start">
                                                                                <label for="tenkh-add" class="col-form-label">Tên khách hàng:</label>
                                                                                <input type="text"
                                                                                       id="tenkh-add"
                                                                                       class="form-control"
                                                                                       autofocus="autofocus"
                                                                                       autocomplete="off" />
                                                                            </div>
                                                                            <div class="mb-3 text-start">
                                                                                <label for="dc-add" class="col-form-label">Địa chỉ:</label>
                                                                                <input type="text"
                                                                                       id="dc-add"
                                                                                       class="form-control"
                                                                                       autofocus="autofocus"
                                                                                       autocomplete="off" />
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-2">
                                                                            <div class="mb-3 text-start">
                                                                                <label for="dt-add" class="col-form-label">Số điện thoại:</label>
                                                                                <input type="text"
                                                                                       id="dt-add"
                                                                                       class="form-control"
                                                                                       autofocus="autofocus"
                                                                                       autocomplete="off" />
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                </div>
                                                                    <div class="add-kh-form-footer d-flex justify-content-end">
                                                                        <button type="button" class="t-s-13 btn btn-outline-secondary mar-5" data-bs-dismiss="modal">Đóng</button>
                                                                    <button type="button" class="t-s-13 btn btn-outline-success mar-5">Lưu</button>
                                                                    </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="table-container">
                                                    <table id="list-makh-sugg" class="sugg-container d-none">
                                                        <tr id="tr-1">
                                                            <td class="width-120">Mã khách hàng</td>
                                                            <td class="width-250">Tên khách hàng</td>
                                                            <td class="width-120">Mã số doanh nghiệp</td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="mb-3 text-start">
                                                <label for="masodn" class="col-form-label">Mã số doanh nghiệp:</label>
                                                <input type="text" class="form-control" id="masodn" readonly>
                                            </div>
                                            <div class="mb-3 text-start">
                                                <label for="input-manv" class="col-form-label">Mã nhân viên:</label>
                                                <input type="text"
                                                       class="form-control input-sugg"
                                                       id="input-manv"
                                                       autofocus="autofocus"
                                                       onkeyup="SearchNow('list-manv-sugg','input-manv','list-manv-sugg')" />
                                                <div class="table-container">
                                                    <table id="list-manv-sugg" class="sugg-container d-none">
                                                        <tr id="tr-1">
                                                            <td class="width-120">Mã nhân viên</td>
                                                            <td class="width-250">Tên nhân viên</td>
                                                            <td class="width-120">Tên phòng ban</td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="mb-3 text-start">
                                                <label for="tennv" class="col-form-label">Tên nhân viên:</label>
                                                <input type="text" class="form-control" id="tennv" readonly>
                                            </div>
                                            <div class="mb-3 text-start">
                                                <label for="tennvgh" class="col-form-label">Tên nhân viên giao:</label>
                                                <input type="text" class="form-control" id="tennvgh" readonly>
                                            </div>
                                        </div>
                                        <div class="col-8">
                                            <div class="mb-3 text-start">
                                                <label for="tenkh" class="col-form-label">Tên khách hàng:</label>
                                                <input type="text" class="form-control" id="tenkh" readonly>
                                            </div>
                                            <div class="mb-3 text-start">
                                                <label for="dc" class="col-form-label">Địa chỉ:</label>
                                                <input type="text" class="form-control" id="dc" readonly>
                                            </div>
                                            <div class="mb-3 text-start">
                                                <label for="dcgh" class="col-form-label">Địa chỉ giao hàng:</label>
                                                <input type="text" class="form-control" id="dcgh" readonly>
                                            </div>
                                            <div class="mb-3 text-start">
                                                <label for="ck" class="col-form-label">Chiết khấu cho tất cả (%):</label>
                                                <div class="d-flex justify-content-between">
                                                    <input type="number" class="form-control width-pt-80" id="ckChung" min="0" max="100" asp-for="PtChietKhau">
                                                    <button class="btn btn-primary b-radius-3 height-30 t-s-12 width-pt-15" type="button" onclick="onCkChung()">Xong</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="id-phieu-nhap" class="col-3 col-num-2">
                                        <div class="mb-3 text-start">
                                            <label for="ht" class="col-form-label">Ngày hạch toán</label>
                                        <input type="datetime-local" class="form-control" asp-for="NgayHToan" id="ht" value="@DateTime.UtcNow.AddHours(7).ToString("s")">
                                        </div>
                                        <div class="mb-3 text-start">
                                            <label for="ct" class="col-form-label">Ngày chứng từ</label>
                                        <input type="datetime-local" class="form-control" id="ct" asp-for="NgayCtu" value="@DateTime.UtcNow.AddHours(7).ToString("s")">
                                        </div>
                                    <div class="mb-3 text-start">
                                        <label for="httt" class="col-form-label">Hình thức thanh toán</label>
                                        <select class="form-select b-radius-3 height-30 width-pt-100 t-s-12" asp-for="HthucThanhToan">
                                            <option value="1">Thanh toán trực tiếp</option>
                                            <option value="2">Nợ</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            @*Hoa don*@
                            <div id="hoa-don" class="row d-none" aria-hidden="true">
                                <div id="infor-hoa-don" class="col-9">
                                    <div class="row">
                                        <div class="col-4 col-num-1">
                                            <div class="mb-3 text-start">
                                                <label for="input-makh" class="col-form-label">Mã khách hàng:</label>
                                                <input type="text"
                                                       class="form-control input-sugg"
                                                       id="input-makh"
                                                       autofocus="autofocus"
                                                       autocomplete="off"
                                                       onkeyup="SearchNow('list-makh-sugg','input-makh','list-makh-sugg')" />
                                                <div class="table-container">
                                                    <table id="list-makh-sugg" class="sugg-container d-none">
                                                        <tr id="tr-1">
                                                            <td class="width-120">Mã khách hàng</td>
                                                            <td class="width-250">Tên khách hàng</td>
                                                            <td class="width-120">Mã số doanh nghiệp</td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="mb-3 text-start">
                                                <label for="tenng" class="col-form-label">Mã số thuế:</label>
                                                <input type="text" class="form-control" id="Tkthue">
                                            </div>
                                        </div>
                                        <div class="col-8">
                                            <div class="mb-3 text-start">
                                                <label for="tenkh" class="col-form-label">Tên khách hàng:</label>
                                                <input type="text" class="form-control" id="tenkh">
                                            </div>

                                            <div class="mb-3 text-start">
                                                <label for="dc" class="col-form-label">Địa chỉ:</label>
                                                <input type="text" class="form-control" id="dc">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="id-phieu-nhap" class="col-3 col-num-2">
                                    <div class="ngay-hach-toan">
                                        <div class="mb-3 text-start">
                                            <label for="tenkh" class="col-form-label">Ngày hạch toán</label>
                                            <input type="datetime-local" class="form-control" id="tenkh">
                                        </div>
                                    </div>
                                    <div class="ngay-chung-tu">
                                        <div class="mb-3 text-start">
                                            <label for="nct" class="col-form-label">Ngày chứng từ</label>
                                            <input type="date" class="form-control" id="nct">
                                        </div>
                                    </div>
                                    <div class="so-phieu-nhap">
                                        <div class="mb-3 text-start">
                                            <label for="tenkh" class="col-form-label">Số phiếu nhập</label>
                                            <input type="text" class="form-control" id="tenkh">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @*Tong tien*@
                        <div class="col-4 bill d-flex flex-column">
                            <div class="bill-title">Hóa đơn</div>
                            <div id="bill-list" class="bill-list d-flex flex-column">
                                <div style="padding: 5px 0" class="bill-menu d-flex justify-content-between">
                                    <div class="t-s-12">Tên danh mục</div>
                                    <div class="t-s-12">Số lượng</div>
                                </div>
                                <div id="list-p" class="bill-content">
                                </div>
                            </div>
                            <div class="so-tien d-flex justify-content-between mt-auto">
                                <div>Tổng tiền: </div>
                                <div id="tongtien">0</div>
                            </div>

                        </div>
                    </div>
                    @*Bonus content*@
                    @* <div class="mua-form">

                    </div> *@
                </div>
                <div class="bottom-content">
                    @*List product *@
                    <table id="list-dm" class="table-text">
                        <tr class="table-menu" id="tr-1">
                            <td class="t-center width-20">#</td>
                            <td class="width-200">Mã Danh Mục</td>
                            <td>Tên Danh Mục</td>
                            <td class="width-50">Đơn vị</td>
                            <td class="width-120">Đơn giá</td>
                            <td class="width-70">Số lượng</td>
                            <td class="width-90">Chiết khấu (%)</td>
                            <td class="width-70">Thuế (%)</td>
                            <td class="width-150">Thành tiền</td>
                            <td class="width-70">Hành động</td>
                        </tr>
                        <tr id="tr1">
                            <td class="t-center td-index">1</td>
                            <td>
                                <input type="text"
                                       class="form-control input-sugg"
                                       id="input-madm-1"
                                       autofocus="autofocus"
                                       autocomplete="off"
                                       asp-for="ktdmDTOs[0].Madm"
                                       onkeyup="SearchNow('list-madm-sugg-1','input-madm-1','list-madm-sugg-1')" />
                                <div class="table-container">
                                    <table id="list-madm-sugg-1" class="sugg-container d-none">
                                        <tr id="tr-1">
                                            <td class="width-120">Mã danh mục</td>
                                            <td class="width-250">Tên danh mục</td>
                                            <td class="width-90">Số lượng tồn</td>
                                        </tr>
                                    </table>
                                </div>
                            </td>
                            <td><input type="text" class="form-control" id="input-tendm-1" asp-for="ktdmDTOs[0].Tendm" readonly />
                                <input type="text" class="form-control" id="input-matk-1" asp-for="ktdmDTOs[0].Matk" hidden readonly />
                            </td>
                            <td><input type="text" class="form-control" id="input-donvi-1" asp-for="ktdmDTOs[0].Donvi" readonly /></td>
                            <td><input type="number" class="form-control" id="input-dongia-1" asp-for="ktdmDTOs[0].Dgban" min="0" onchange="tinhTien(1)" /></td>
                            <td><input type="number" class="form-control" id="input-soluong-1" asp-for="ktdmDTOs[0].Soluong" min="1" onchange="tinhTien(1)" /></td>
                            <td><input type="number" class="form-control" id="input-ck-1" asp-for="ktdmDTOs[0].PtChietKhau" min="0" max="100" onchange="tinhTien(1)" /></td>
                            <td><input type="number" class="form-control" id="input-thue-1" asp-for="ktdmDTOs[0].PtThue" min="0" max="100" onchange="tinhTien(1)" /></td>
                            <td><input type="text" class="form-control" id="input-thanhtien-1" readonly /></td>
                            <td class="t-center"><a onClick="xoaDm('tr1')" class="dx-link dx-link-delete dx-icon-trash dx-link-icon table-icon"></a></td>
                        </tr>
                    </table>
                    <div class="buttons d-flex justify-content-between mar-5">
                        <button class="btn btn-success t-s-12 height-30" id="addDm" onclick="themDm()" type="button">Thêm danh mục</button>
                        <button class="btn btn-warning t-s-12 height-30" id="exportBill" onclick="exportPDF()" type="button">Xuất hóa đơn</button>
                        <button class="btn btn-primary t-s-12 height-30" id="saveButton" type="submit">Lưu đơn bán</button>
                    </div>
                </div>
            </form>

            <script type="text/javascript">
                let count = 1;
                let index = 1;
                var exist = [];
                exist.push(1);
                var data = [];
                var madmItems = []
                var element;

                let ptCkChung = 0;
                let isCkChung = false;

                ////FUNCTION/////////////////////////////////////////
                function getDataGridInstance() {
                    let element = $("#grid-container");
                    return DevExpress.ui.dxDataGrid.getInstance(element);
                }
                async function save() {
                    $("#grid-container div [role='button']")[0].click();
                    // $("#saveButton").after(`<button type="button" onclick="Submit()">Mua sản phẩm</button>`)
                }
                function tinhTien(rowIndex) {
                    var sl = document.getElementById("input-soluong-" + rowIndex).value;
                    var dgia = $(`#input-dongia-${rowIndex}`)[0].value;
                    var ck = $(`#input-ck-${rowIndex}`)[0].value;
                    var thue = $(`#input-thue-${rowIndex}`)[0].value;
                    for (let i = 0; i < madmItems.length; i++) {
                        var tr = document.getElementById("tr" + rowIndex);
                        if (madmItems[i].trId == ("tr" + rowIndex)) {
                            madmItems[i].Soluong = parseInt(sl);
                            madmItems[i].Dgban = parseInt(dgia);
                            madmItems[i].PtChietkhau = parseInt(ck);
                            madmItems[i].PtThue = parseInt(thue);

                            // Gắn giá trị vào các thẻ <td>
                            var thanhtien = madmItems[i].Soluong * (madmItems[i].Dgban * (1 - madmItems[i].PtChietkhau / 100)) * (1 + madmItems[i].PtThue / 100);
                            tr.querySelector('#input-thanhtien-' + rowIndex).value = parseFloat(thanhtien).toFixed(0);
                            break;
                        }
                    }
                    console.log(madmItems);
                    loadBill();
                }

                async function selection_changed(selectedItems) {
                    var dataGrid = getDataGridInstance();
                    data = selectedItems.selectedRowsData;
                    $('#bill-list .bill-product-name').empty();
                    $.each(data, function (i, product) {
                        if (product.Donvi != "") {
                            $('#bill-list .bill-content').append('<div class="bill-product d-flex justify-content-between">' + '<div class="product-name">' + product.Tendm + '</div><div class="product-number">' + product.Soluong + '</div></div>')
                        }
                    });
                }


                function Updated() {
                }
                function hoadonOut() {
                    document.getElementById("hoa-don").classList.remove("d-none");
                    document.getElementById("phieu-nhap").classList.add("d-none");
                    document.getElementById("btn-phieunhap").classList.remove("active");
                    document.getElementById("btn-hoadon").classList.add("active");
                }
                function phieuOut() {
                    document.getElementById("hoa-don").classList.add("d-none");
                    document.getElementById("phieu-nhap").classList.remove("d-none");
                    document.getElementById("btn-hoadon").classList.remove("active");
                    document.getElementById("btn-phieunhap").classList.add("active");
                }

                function SearchNow(idSugg, idInput, idUl) {
                    document.getElementById(idSugg).classList.remove("d-none");
                    // Declare variables
                    var input, filter, ul, li, a, i;
                    input = document.getElementById(idInput);
                    filter = input.value.toUpperCase();
                    ul = document.getElementById(idUl);
                    li = ul.getElementsByTagName('li');

                    var table = document.getElementById(idSugg);
                    var tr = table.getElementsByTagName('tr');
                    for (i = 1; i < tr.length; i++) {
                        var tdMa = tr[i].getElementsByTagName("td")[0];
                        var maValue = tdMa.textContent || tdMa.innerText;
                        var tdTen = tr[i].getElementsByTagName("td")[1];
                        var tenValue = tdTen.textContent || tdTen.innerText;

                        if (maValue.toUpperCase().indexOf(filter) > -1 || tenValue.toUpperCase().indexOf(filter) > -1) {
                            var isNone = false;
                            console.log("tenn:" + tenValue);
                            for (let u = 0; u < madmItems.length; u++) {
                                if (maValue.toUpperCase() == madmItems[u].Madm.toUpperCase()) {
                                    tr[i].style.display = "none";
                                    isNone = true;
                                    break;
                                }
                            }
                            if (!isNone) tr[i].style.display = "";
                        } else {
                            tr[i].style.display = "none";
                        }
                    }
                }

                var madm = [
                    {
                        Madm: "",
                        Tendm: "",
                        TonT: ""
                    }
                ];
                $.ajax({
                    url: '@Url.Action("Get", "Ktdms")',
                    type: 'GET',
                    success: function (result) {
                        if (result.data.length > 0) {
                            madm = result.data;
                            for (var i = 0; i < madm.length; i++) {
                                const list = document.getElementById("list-madm-sugg-" + count);
                                list.insertAdjacentHTML('beforeend', `
                                                                <tr class="tr-sugg" onclick="madmChooseItem(this.closest('table').closest('tr').id,'${encodeURIComponent(JSON.stringify(madm[i]))}')"><td>${madm[i].Madm}</td><td>${madm[i].Tendm}</td><td>${madm[i].TonT}</td></tr>
                                                `);
                            }
                        }
                    }
                });

                function madmChooseItem(id, item) {
                    hide_sugg("list-madm-sugg-" + id[2]);
                    var chietkhau = 0;
                    if (isCkChung == true) chietkhau = ptCkChung;
                    var addItem = JSON.parse(decodeURIComponent(item));
                    var madmDTO = {
                        Matk: addItem.Matk,
                        Madm: addItem.Madm,
                        Tendm: addItem.Tendm,
                        Donvi: addItem.Donvi,
                        Soluong: 1,
                        Dgban: 0,
                        TonTDv1: addItem.TonTDv1,
                        PtChietkhau: chietkhau,
                        PtThue: 0,
                        trId: id,
                    }
                    var dmindex = id[2];
                    var isExist = false;
                    for (let i = 0; i < madmItems.length; i++) {
                        if (madmItems[i].trId[2] == dmindex) {
                            isExist = true;
                            dmindex = i;
                            break;
                        }
                    }
                    if (!isExist) {
                        madmItems.push(madmDTO);
                    }
                    else {
                        madmItems[dmindex] = madmDTO;
                    }
                    var numId = id[2];
                    console.log(madmItems)
                    // Lấy thẻ <tr> có id là "tr1"
                    var tr = document.getElementById(id);
                    // Gắn giá trị vào các thẻ <td>
                    tr.querySelector('#input-matk-' + id[2]).value = JSON.parse(decodeURIComponent(item)).Matk;
                    tr.querySelector('#input-madm-' + id[2]).value = JSON.parse(decodeURIComponent(item)).Madm;
                    tr.querySelector('#input-tendm-' + id[2]).value = JSON.parse(decodeURIComponent(item)).Tendm;
                    tr.querySelector('#input-donvi-' + id[2]).value = JSON.parse(decodeURIComponent(item)).Donvi;
                    tr.querySelector('#input-dongia-' + id[2]).value = 0;
                    tr.querySelector('#input-soluong-' + id[2]).value = 1;
                    tr.querySelector('#input-thanhtien-' + id[2]).value = 0;
                    tr.querySelector('#input-ck-' + id[2]).value = chietkhau;
                    tr.querySelector('#input-thue-' + id[2]).value = 0;
                    loadBill();
                }
                function loadBill(){
                    var listP = document.getElementById("list-p");
                    var divs = listP.getElementsByClassName("pro");
                    while (divs.length > 0) {
                        divs[0].parentNode.removeChild(divs[0]);
                    }
                    var tongtien = 0;
                    for (let i = 0; i < madmItems.length; i++) {
                        var numId = exist[i];
                        var name = madmItems[i].Tendm;
                        var num = madmItems[i].Soluong;
                        listP.insertAdjacentHTML('beforeend', `
                                             <div id="p${numId}" class="pro d-flex justify-content-between">
                                                        <div id="name${numId}" class="bill-product-name">
                                                        ${name}
                                                        </div>
                                                        <div id="nber${numId}" class="bill-product-number">
                                                        ${num}
                                                        </div>
                                             </div>
                        `);
                        tongtien = tongtien + parseInt(document.getElementById("input-thanhtien-" + numId).value);
                    }
                    document.getElementById("tongtien").textContent = tongtien;
                }
                var makh = [
                    {
                        Madtpn: "",
                        Tendtpn: "",
                        MsDn: ""
                    }
                ];
                $.ajax({
                    url: '@Url.Action("Get", "Ktdtpns")',
                    type: 'GET',
                    success: function (result) {
                        if (result.data.length > 0) {
                            makh = result.data;
                            for (var i = 0; i < makh.length; i++) {
                                const list = document.getElementById("list-makh-sugg");
                                list.insertAdjacentHTML('beforeend', `
                                                       <tr class="tr-sugg" onclick="makhChooseItem('${encodeURIComponent(JSON.stringify(makh[i]))}')"><td>${makh[i].Madtpn}</td><td>${makh[i].Tendtpn}</td><td>${makh[i].MsDn}</td></tr>
                                                `);
                            }
                        }
                    }
                });
                var makhItems = []
                function makhChooseItem(item) {
                    makhItems = JSON.parse(decodeURIComponent(item));
                    console.log(makhItems);
                    hide_sugg("list-makh-sugg");
                    // Gắn giá trị vào các thẻ <td>
                    document.getElementById('input-makh').value = JSON.parse(decodeURIComponent(item)).Madtpn;
                    document.getElementById('tenkh').value = JSON.parse(decodeURIComponent(item)).Tendtpn;
                    document.getElementById('dc').value = JSON.parse(decodeURIComponent(item)).Diachi;
                    document.getElementById('masodn').value = JSON.parse(decodeURIComponent(item)).MsDn;
                }

                const manv = [
                    'how to mak',
                    'how to make',
                    'html explore ',
                    'css explore',
                    'dom explore',
                    'more items',
                    'how to make a slidebar',
                    'how to make this website',
                    'html explore ',
                    'css explore',
                    'dom explore',
                    'more items add hare that you want to suggest',
                    'how to make a slidebar',
                    'how to make this website',
                    'html explore ',
                    'css explore',
                    'dom explore',
                    'more items add hare that you want to suggest'
                ]
                for (var i = 0; i < manv.length; i++) {
                    const list = document.getElementById("list-manv-sugg");
                    list.insertAdjacentHTML('beforeend', `
                                                      <tr><td>${manv[i]}</td><td>${manv[i + 1]}</td><td>${manv[i + 2]}</td></tr>
                                                                                                         `);
                }

                //hide suggestions
                function hide_sugg(idSugg) {
                    document.getElementById(idSugg).classList.add("d-none");
                }
                document.addEventListener('click', function (event) {
                    for (let i = 0; i < exist.length; i++) {
                        var container = document.getElementById("list-madm-sugg-" + exist[i]);
                        if (!container.contains(event.target) && !container.classList.contains("d-none")) {
                            hide_sugg("list-madm-sugg-" + exist[i]);
                            break;
                        }
                    }
                    if (!document.getElementById("list-makh-sugg").contains(event.target) && !document.getElementById("list-makh-sugg").classList.contains("d-none")) {
                        hide_sugg("list-makh-sugg");
                    }
                    if (!document.getElementById("list-manv-sugg").contains(event.target) && !document.getElementById("list-manv-sugg").classList.contains("d-none")) {
                        hide_sugg("list-manv-sugg");
                    }
                });


                function themDm() {
                    if (madmItems.length == index) {
                        var table = document.getElementById("list-dm");
                        count++;
                        index++;
                        table.insertAdjacentHTML('beforeend', `
                                                                    <tr id="tr${count}">
                                                                            <td class="t-center td-index">${index}</td>
                                                                            <td>
                                                                                <input type="text"
                                                                                       class="form-control input-sugg"
                                                                                       id="input-madm-${count}"
                                                                                       autofocus="autofocus"
                                                                                       name="ktdmDTOs[${count - 1}].Madm"
                                                                                       onkeyup="SearchNow('list-madm-sugg-${count}','input-madm-${count}','list-madm-sugg-${count}')" />
                                                                                <div class="table-container">
                                                                                    <table id="list-madm-sugg-${count}" class="sugg-container d-none">
                                                                                        <tr id="tr-1">
                                                                                            <td class="width-120">Mã danh mục</td>
                                                                                            <td class="width-250">Tên danh mục</td>
                                                                                            <td class="width-90">Số lượng tồn</td>
                                                                                        </tr>
                                                                                    </table>
                                                                                </div>
                                                                            </td>

                                                                            <td><input type="text" class="form-control" id="input-tendm-${count}" name="ktdmDTOs[${count - 1}].Tendm" readonly />
                                                                            <input type="text" class="form-control" id="input-matk-${count}" name="ktdmDTOs[${count - 1}].Matk" hidden readonly /></td>
                                                                            <td><input type="text" class="form-control" id="input-donvi-${count}" name="ktdmDTOs[${count - 1}].Donvi" readonly /></td>
                                                                            <td><input type="number" class="form-control" id="input-dongia-${count}" name="ktdmDTOs[${count - 1}].Dgban" min="0" onchange="tinhTien(${count})" /></td>
                                                                            <td><input type="number" class="form-control" id="input-soluong-${count}" name="ktdmDTOs[${count - 1}].Soluong" min="1" onchange="tinhTien(${count})" /></td>
                                                                            <td><input type="number" class="form-control" id="input-ck-${count}" name="ktdmDTOs[${count - 1}].PtChietKhau" min="0" max="100" onchange="tinhTien(${count})" /></td>
                                                                            <td><input type="number" class="form-control" id="input-thue-${count}" name="ktdmDTOs[${count - 1}].PtThue" min="0" max="100" onchange="tinhTien(${count})" /></td>
                                                                            <td><input type="number" class="form-control" id="input-thanhtien-${count}" readonly/></td>
                                                                            <td class="t-center"><a onClick="xoaDm('tr${count}')" class="dx-link dx-link-delete dx-icon-trash dx-link-icon table-icon"></a></td>
                                                                        </tr>
                                    `);
                        $.ajax({
                            url: '@Url.Action("Get", "Ktdms")',
                            type: 'GET',
                            success: function (result) {
                                if (result.data.length > 0) {
                                    madm = result.data;
                                    for (var i = 0; i < madm.length; i++) {
                                        const list = document.getElementById("list-madm-sugg-" + count);
                                        list.insertAdjacentHTML('beforeend', `
                                                                                <tr class="tr-sugg" onclick="madmChooseItem(this.closest('table').closest('tr').id,'${encodeURIComponent(JSON.stringify(madm[i]))}')"><td>${madm[i].Madm}</td><td>${madm[i].Tendm}</td><td>${madm[i].TonT}</td></tr>
                                                                `);
                                    }
                                }
                            }
                        });
                        exist.push(count);
                    }
                }
                function xoaDm(id) {
                    if (index > 1) {
                        var tr = document.getElementById(id);
                        for (let i = 0; i < exist.length; i++){
                            if (exist[i] == id[2]) {
                                exist.splice(i, 1);
                            }
                        }
                        for (let i = 0; i < madmItems.length; i++) {
                            if(madmItems[i].trId == id){
                                madmItems.splice(i,1);
                                console.log("xoa:" + madmItems);
                            }
                        }
                        tr.remove();
                        index--;
                        var idList = [];
                        for (let i = 1; i <= index; i++) {
                            idList.push(i);
                        }
                        console.log(idList);
                        var tdList = document.getElementsByClassName("td-index");
                        for (let i = 0; i < tdList.length; i++){
                            tdList[i].textContent = idList[i];
                        }
                        loadBill();
                    }
                }
                function Submit() {
                    console.log(madm)
                    setTimeout(function (value) {
                        $.ajax({
                            url: '@Url.Action("SubmitCartToExport", "Ktdms")',
                            type: 'POST',
                            data: JSON.stringify(madm),
                            success: function (result) {
                                console.log(result)
                                //window.location.replace("/Home/ExportBuyProduct")
                                window.open("https://localhost:7278/InvoiceReport/HoaDon.pdf", "_blank");
                            }
                        });
                    }, 1000)
                    save().then()
                }
                document.getElementById('myForm').onkeypress = function (e) {
                    var key = e.charCode || e.keyCode || 0;
                    if (key == 13) {
                        e.preventDefault();
                    }
                }
                function exportPDF() {
                    var idKh = document.getElementById("input-makh").value;
                    var idHt = document.getElementById("ht").value;
                    var idKt = document.getElementById("ct").value;
                    var khs = [
                    ];

                    for (let i = 0; i < madmItems.length; i++) {
                        var madmDTO = {
                            Matk: madmItems[i].Matk,
                            Madm: madmItems[i].Madm,
                            Tendm: madmItems[i].Tendm,
                            Donvi: madmItems[i].Donvi,
                            Soluong: madmItems[i].Soluong,
                            Dgban: madmItems[i].Dgban,
                            TonTDv1: madmItems[i].TonTDv1,
                        }
                        khs.push(madmDTO);
                    }
                    console.log(idKh);
                    var myKeyVals = {
                        Makh: idKh,
                        NgayCtu: idKt,
                        NgayHToan: idHt,
                        ktdmDTOs: khs,
                    }
                    $.ajax({
                        url: '@Url.Action("SubmitCartToExport", "Ktdms")',
                        type: 'POST',
                        data: myKeyVals,
                        success: function (result) {
                            console.log(result);
                            window.open("https://localhost:7278/InvoiceReport/HoaDon.pdf", "_blank");
                        }
                    });
                }
                function listOut() {
                    var linkData = document.getElementById("data-link");
                    var muaData = document.getElementById("mua-data");
                    var linkOrder = document.getElementById("order-link");
                    var form = document.getElementById("myForm");
                    if (!linkData.classList.contains("active")) {
                        linkData.classList.add("active");
                        linkOrder.classList.remove("active");
                        muaData.classList.remove("d-none");
                        form.classList.add("d-none");
                    }
                }
                function orderOut() {
                    var linkData = document.getElementById("data-link");
                    var muaData = document.getElementById("mua-data");
                    var linkOrder = document.getElementById("order-link");
                    var form = document.getElementById("myForm");
                    linkData.classList.remove("active");
                    muaData.classList.add("d-none")
                    linkOrder.classList.add("active");
                    form.classList.remove("d-none");
                }
                $(document).ready(function () {
                    $.ajax({
                        url: '@Url.Action("GetALLDSPhieuBanHang", "Ktscs")', // Thay 'ControllerName' bằng tên thực của controller
                        type: 'GET',
                        success: function (data) {
                            console.log("heia");
                            var table = $('<table/>').addClass('dataTable');
                            $.each(data, function (i, obj) {
                                var row = $('<tr/>');
                                $.each(obj, function (key, value) {
                                    $('<td/>').text(value).appendTo(row);
                                });
                                table.append(row);
                            });
                            $('#mua-data').html(table);
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                });
                function error(error) {
                }

                function onCkChung() {
                    isCkChung = true;
                    ptCkChung = document.getElementById("ckChung").value
                    for (let i = 0; i < madmItems.length; i++) {
                        var id = madmItems[i].trId;
                        var tr = document.getElementById(id);
                        madmItems[i].PtChietkhau = ptCkChung;
                        document.getElementById("input-ck-" + id[2]).value = ptCkChung;
                        tinhTien(id[2]);
                    }
                }
                function edit(e) {
                    if (e.rowIndex != -1) {
                        if (!e.items) e.items = [];
                        const contextMenuItem = [
                            {
                                text: "Sửa",
                                onItemClick: function (args) {
                                    var grid = document.getElementById("grid");
                                    var row = grid.getElementsByClassName("dx-row-focused")[0];
                                    var id = e.row.data.id;
                                    console.log(id);
                                    document.getElementById("edit-page").classList.remove("d-none");
                                    document.getElementById("edit-page").classList.add("d-relative");
                                    $.ajax({
                                        url: '@Url.Action("GetDetailPhieuBanHang", "Ktscs")',
                                        type: 'GET',
                                        data: {
                                            id: id
                                        },
                                        success: function (result) {
                                            console.log(result);
                                            var editPage = document.getElementById("edit-page");
                                            var modal = editPage.getElementsByClassName("buy-edit");
                                            while (modal.length > 0) {
                                                modal[0].parentNode.removeChild(modal[0]);
                                            }
                                            $("#edit-page").append(result);
                                        }
                                    });
                                }
                            },
                        ];
                        contextMenuItem.forEach((item) => {
                            e.items.push(item);
                        })
                    }
                }
                function closeEdit() {
                    document.getElementById("edit-page").classList.add("d-none");
                    document.getElementById("edit-page").classList.remove("d-relative");
                    //location.reload();
                }
            </script>
        </div>
    </div>
</div>


